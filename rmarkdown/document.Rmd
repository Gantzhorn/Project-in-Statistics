---
title: "Project In Statistics"
author: "Anders Gantzhorn Kristensen"
date: "2023-04-29"
output: html_document
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(momentuHMM)
library(ggmap)
library(plotly)
library(gridExtra)
library(geodata)
library(plot3D)
library(grid)
library(rayshader)
library(xtable)
library(sf)
library(mapview)
library(ggthemes)
theme_set(theme_bw())
proj_palette <- c("#E69F00", "#56B4E9", "#009E73",
                         "#F0E442", "#0072B2", "#D55E00",
                         "#CC79A7")
plotPath = "/home/anders/Desktop/Skole/Blok 4 - 2023/Project in Statistics/Project-in-Statistics/latex/figures"
```

# Analysis of eagle data

First we load the data and calculate the vertical_steps by looking at the changing in altitude to the last position

```{r, include=FALSE, message = FALSE}
eagleDataOriginal <- readr::read_csv("Eagle_data_with_GPS_positions.csv")
eagleData <- eagleDataOriginal
eagleData %>% mutate(Segment_ID = factor(Segment_ID))
eagleData <- eagleData %>% group_by(Segment_ID) %>%
    mutate(vertical_steps = Altitude - lag(Altitude, default = first(Altitude))) %>% 
    rename(horizontal_steps = Step_length) %>% 
    slice(2:n())
```

# Plot the tracks of the birds
```{r, echo = FALSE}
allBirdsMap <- ggmap::get_stamenmap(bbox = c(left = min(eagleData$Longitude),
                              right = -73,
                              bottom = min(eagleData$Latitude),
                              top = 43),
                              maptype = "terrain-background",
                              crop = FALSE,
                              zoom = 9)
USMAP <- ggmap::get_stamenmap(bbox = c(left = -125, right = -67, bottom = 24, top = 49),
                              maptype = "terrain-background",
                              crop = FALSE,
                              zoom = 6)

allBirdsMapZoomed <- ggmap(USMAP) + theme(axis.title = element_blank(), 
          axis.text  = element_blank(),
          axis.ticks = element_blank()) +
  geom_rect(xmin = min(eagleData$Longitude), xmax =  -73, ymin =  min(eagleData$Latitude), ymax =  43,
            fill = NA, color = "firebrick", linewidth = 0.6)
rm(USMAP)
allBirdsAndInset <- ggmap(allBirdsMap) +
  geom_point(data = eagleData, aes(x = Longitude, y = Latitude, group = Segment_ID),
             col = "black", size = 0.0001) +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14, face = "bold")) +
  ggmap::inset(ggplotGrob(allBirdsMapZoomed), xmin = -76, xmax = -73, ymin = 38, ymax = 41.4) +
  labs(x = "Longitude (°)", y = "Latitude (°)")
allBirdsAndInset
ggsave(filename = "allBirdTracks.jpeg", plot = allBirdsAndInset, path = plotPath, width = 12.26, height = 9.77)
```

# Simple summary statistics

```{r, include = FALSE}
eagleData %>% ungroup() %>% select(Longitude, Latitude, horizontal_steps, vertical_steps) %>% summary() %>% xtable(include.rownames = FALSE)

horizontal_marginal <- eagleData %>% 
  ggplot(aes(x = horizontal_steps)) +
  geom_density(color = "black", fill = proj_palette[1], linewidth = 0.5) +
  labs(y = NULL, x = "Horizontal Step Length") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12, face = "bold"),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +  scale_x_log10()

vertical_marginal <- eagleData %>% 
  ggplot(aes(x = vertical_steps)) +
  geom_density(color = "black", fill = proj_palette[2], linewidth = 0.5) +
  labs(y = NULL, x = "Vertical Step Length") +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12, face = "bold"),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

verticalHorizontal_joint <- ggplot(eagleData, aes(x = horizontal_steps, y = vertical_steps)) +
  stat_density_2d(aes(fill = ..level..), geom = "polygon", colour = "white") +
  scale_fill_gradientn(colors = c(proj_palette[1], proj_palette[5])) +
  labs(x = "Horizontal Steplength", y = "Vertical Steplength", fill = "Density") + scale_x_log10() + 
    theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12, face = "bold"),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  guides(fill = guide_colorbar(title.position = "top", title.theme = element_text(face = "bold")))
  

marginalAndJointDistributions <- grid.arrange(verticalHorizontal_joint, horizontal_marginal, vertical_marginal,
             layout_matrix = matrix(c(2, 2, 2, 2, 3, 3, 3, 3, NA, 1, 1 ,1, 1, 1, 1, NA), nrow = 2,byrow = TRUE))

ggsave(filename = "horizontalAndVerticalDensities.jpeg", plot = marginalAndJointDistributions, path = plotPath)
```
## Estimation using Weibull- and Gamma distributions
### Weibull distribution
First assume that Step_length is Weibull distributed. The MLE of $k$ is the solution to
$$
0 = \frac{\sum_{i = 1}^N X_i^k\log(X_i)}{\sum_{i = 1}^N X_i^k} - \frac{1}{k} - \frac{1}{N}\sum_{i = 1}^N \log(X_i)
$$
whereas the MLE of $\lambda$ given $k$ is:
$$
\hat{\lambda} = \left(\frac{1}{N} \sum_{i = 1}^N X_i^k\right)^{\frac{1}{k}}
$$
Thus we can calculate the MLE assuming step-length has a Weibull distribtion
```{r message = FALSE}
k_hat <- uniroot(function(k) {sum(eagleData$horizontal_steps^k * log(eagleData$horizontal_steps)) / sum(eagleData$horizontal_steps^k) - 1/k - mean(log(eagleData$horizontal_steps))},
                    c(0.1, 10))$root
lambda_hat <- (mean(eagleData$horizontal_steps^k_hat))^(1/k_hat)
```
### Gamma distribution
MLE of shape parameter in gamma distribution is the solution to the equation:
$$
\log(\alpha)-\psi(\alpha) = \log\left(\frac{1}{N}\sum_{i=1}^N\log(X_i)\right)-\frac{1}{N}\sum_{i = 1}^N\log(X_i)
$$
Whereas the rate parameter is given by
$$\hat{\beta} = \frac{\hat{\alpha}}{\sum_{i = 1}^N X_i}$$

```{r}
alpha_hat <- uniroot(function(alpha) {log(alpha)-digamma(alpha)-log(mean(eagleData$horizontal_steps))+mean(log(eagleData$horizontal_steps))},c(0.1, 10))$root
beta_hat <- alpha_hat/mean(eagleData$horizontal_steps)
```

### Fitting the vertical steps to a normal distribution
The MLE of the mean in the normal distribution is:
$$
\hat{\mu} = \frac{1}{N}\sum_{i = 1}^N X_i
$$
Whereas the variance is:
$$
\hat{\sigma}² = \frac{1}{N}\sum_{i = 1}^N \left(X_i-\hat{\mu}\right)^2
$$
Which we implement.
```{r message = FALSE}
mu_hat <- mean(eagleData$vertical_steps)
sigmasq_hat <- var(eagleData$vertical_steps)
```


```{r message = FALSE}
prepEagleData <- momentuHMM::prepData(data = data.frame(ID = eagleData$Segment_ID,
                                       vertical_steps = eagleData$vertical_steps,
                                       horizontal_steps = eagleData$horizontal_steps),
                                       coordNames = NULL)
```
We also need the number of observations per animal for the validation process later.
```{r message = FALSE}
obsPerAnimal <- as.list(as.numeric(table(prepEagleData$ID))) 
```

## Model fitting

We fit the model using the parameters from above and decode the states
```{r message = FALSE}
N <- 3 
# Initial values for weibull distributions of horizontal distances
k0 <- rep(k_hat, times = N)
lambda0 <- rep(lambda_hat, times = N)

# Initial values for normal distributions for vertical distances
mu0 <- rep(mu_hat, times = N)
sigma0 <- rep(sigmasq_hat, times = N)
eagleFit1 <- momentuHMM::fitHMM(prepEagleData,
                   nbStates = N,
                   dist = list(horizontal_steps = "weibull",
                          vertical_steps = "norm"),
                   Par0 = list(horizontal_steps = c(k0, lambda0),
                          vertical_steps = c(mu0, sigma0))
)

decodedStatesFit1 <- viterbi(m = eagleFit1)

```
Instead of using the generic plot method, we can use our own

```{r message = FALSE}
numberAfterState <- decodedStatesFit1 %>% tibble(stateNum=.) %>% group_by(stateNum) %>% count() %>% ungroup() %>% mutate(prop = n/sum(n))
```

```{r message = FALSE}
# Set the parameters for the Weibull distributions
shape_params <- eagleFit1$mle$horizontal_steps[1,]
scale_params <- eagleFit1$mle$horizontal_steps[2,]

# Set the number of observations for each distribution
num_observations <- c(numberAfterState$n[numberAfterState$stateNum == 1], 
                      numberAfterState$n[numberAfterState$stateNum == 2], 
                      numberAfterState$n[numberAfterState$stateNum == 3])

# Generate the x values
x <- density(eagleData$horizontal_steps)$x

# Calculate the density values for each distribution
pdf_values <- sapply(1:N, function(i) {
  density <- dweibull(x, shape = shape_params[i], scale = scale_params[i])
  density <- density * numberAfterState$prop[numberAfterState$stateNum == i]
  density
})



# Create a data frame for the density values
df <- data.frame(x = rep(x, (N+1)),
                 density = as.vector(cbind(pdf_values, rowSums(pdf_values))),
                 state = factor(rep(c(1:N, "Total"), each = length(x))))

# Plot the density functions using ggplot2
ggplot() + 
  geom_histogram(data = eagleData, aes(x = horizontal_steps, after_stat(density)), fill = "gray", col = "black") +
  geom_line(data = filter(df, state != "Total"), aes(x = x, y = density, color = state),
                lwd = 1, alpha = 1.5) +
  geom_line(data = filter(df, state == "Total"), aes(x = x, y = density),
                lwd = 1, alpha = 1.5, linetype = "dashed") +
  xlab("x") +
  ylab("Density") +
  scale_color_manual(values = proj_palette)
```

Add decoded states to the dataset
```{r message = FALSE}
eagleData <- tibble(eagleData, decodedstates = decodedStatesFit1)
```
And plot the data stratified to the states
```{r message = FALSE}
eagleData <- eagleData %>% mutate(decodedstates = factor(decodedstates))

ggplot(eagleData, aes(x = horizontal_steps, y = vertical_steps, col = decodedstates)) + geom_point(alpha = .6) +
  scale_color_manual(values = proj_palette)
```

## Assess the fitted model
Look at simulations from the model and whether they show similar patterns as the observed data. First we simulate from the model

```{r message = FALSE, include = FALSE}
eagleSim <- momentuHMM::simData(nbAnimals = max(as.numeric(levels(prepEagleData$ID))),
                                nbStates = N,
                                model = eagleFit1,
                                obsPerAnimal = obsPerAnimal)
eagleSim
```

Then we compare the densities qualitatively

```{r message = FALSE}
bind_rows(eagleSim, prepEagleData) %>%
    mutate(Data = rep(c("Sim", "Obs"), each = nrow(eagleSim))) %>%
  pivot_longer(cols = -c(ID, Data), names_to = "Movement_type", values_to = "Move") %>% 
  ggplot(aes(x = Move, fill = Data)) + geom_density() +
  scale_fill_manual(values = proj_palette) + facet_wrap(~Movement_type, ncol = 1, scale = "free")
```

Now we compute the pseudoresiduals

```{r message = FALSE}
pseudoReseagleFit1 <- momentuHMM::pseudoRes(eagleFit1)
pseudoResTibble <- tibble(horizontal_stepsRes = pseudoReseagleFit1[[1]],
                          vertical_stepsRes = pseudoReseagleFit1[[2]]
                          ) %>% mutate(time = row_number())
```

```{r message = FALSE}
# Chain independence:
pseudoResTibble %>% ggplot(aes(x = time, y = horizontal_stepsRes)) +
  geom_line(color = proj_palette[5])
```

```{r message = FALSE}
# Histogram of residuals with standard normal distribution on top
pseudoResTibble %>% ggplot(aes(x = vertical_stepsRes)) +
  geom_histogram(aes(y = after_stat(density)),col = "black", fill = proj_palette[6], alpha = 0.8) + 
  stat_function(fun = dnorm, args = list(mean = 0, sd = 1), color = proj_palette[5], linewidth = 1)
```

```{r message = FALSE}
# QQ-plot of residuals
pseudoResTibble %>% ggplot(aes(sample = horizontal_stepsRes)) + 
  geom_qq() +
  geom_abline(intercept = 0, slope = 1, color = "red") +
  labs(title = "QQ Plot of Horizontal Steps Pseudo Residuals")
```

```{r message = FALSE}
# Make autocorrelation plots
acf_vals <- acf(pseudoResTibble$vertical_stepsRes[is.finite(pseudoResTibble$vertical_stepsRes)], plot = FALSE)
acftib <- tibble(ACF = acf_vals$acf, lag = acf_vals$lag)
ggplot(acftib, aes(x = lag, y = ACF)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_hline(yintercept = c(0.025, -0.025), linetype = "dashed", color = proj_palette[3]) +
  geom_segment(aes(xend = lag, yend = 0), color = "black") +
  xlab("Lag") +
  ylab("Autocorrelation")
```

## Plot a few individual birds
### Using mapview
```{r message = FALSE}
 # Find segment with the most observations:
favourite_bird <- eagleData %>% group_by(Segment_ID) %>% summarise(n = n()) %>% ungroup() %>% 
  slice_max(n) %>% .$Segment_ID

# Find interesting birds:
eagleData %>% group_by(Segment_ID, decodedstates) %>% summarise(n = n()) %>% ungroup() %>% group_by(Segment_ID) %>% mutate(prop = n/sum(n)) %>% select(Segment_ID, decodedstates, prop) %>%  pivot_wider(names_from = "decodedstates", values_from = "prop") %>%
  mutate(across(where(is.double), ~ replace_na(., 0))) %>% filter(`1`>0.25 & `2`>0.25 & `3`>0.25)


favourite_birdTibble <- eagleData %>% filter(Segment_ID == 48)
mapview::mapview(favourite_birdTibble, xcol = "Longitude", ycol = "Latitude", crs = 4326,
                 grid = FALSE, zcol = "decodedstates")
```
### Using ggmap

```{r}
favoriteBirdMap <- ggmap::get_stamenmap(bbox = c(left = min(favourite_birdTibble$Longitude),
                              right = max(favourite_birdTibble$Longitude),
                              bottom = min(favourite_birdTibble$Latitude),
                              top = max(favourite_birdTibble$Latitude)),
                              maptype = "terrain",
                              crop = FALSE,
                              zoom = 11)

favoriteBirdMapAndTracks <- ggmap(favoriteBirdMap)+
  geom_line(data = favourite_birdTibble, aes(x = Longitude, y = Latitude),
            lwd = 0.1, col = "black") + 
  geom_point(data = favourite_birdTibble, aes(x = Longitude, y = Latitude, col = decodedstates)) +
  scale_color_manual(values = proj_palette) +
  labs(title = "Segment 48 path",
       x = "Longitude",
       y = "Latitude") +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 10),
        legend.position = "bottom")
favoriteBirdMapAndTracks
```
## Try plotting the tracks in 3D



```{r}
fig <- plot_ly(favourite_birdTibble, x = ~Longitude, y = ~Latitude, z = ~Altitude, color = ~decodedstates,
               colors = proj_palette[1:3])

fig <- fig %>% add_markers()

fig <- fig %>% layout(scene = list(xaxis = list(title = 'Longitude'),

                     yaxis = list(title = 'Latitude'),

                     zaxis = list(title = 'Altitude')))
fig
```

